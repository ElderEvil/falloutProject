# v2.7.0 Test Coverage - Backend + Frontend Component Tests

## TL;DR

> **Quick Summary**: Comprehensive test coverage for v2.7.0 storage management features (scrap/sell/vault filtering) + critical gap-filling from previous updates
>
> **Deliverables**:
> - 25+ backend API tests for scrap/sell/filtering endpoints
> - 24+ frontend component tests for storage UI
> - Coverage increase: Backend >85%, Frontend >15%
>
> **Estimated Effort**: Medium (8-12 hours)
> **Parallel Execution**: YES - 3 waves (backend → frontend components → integration verification)
> **Critical Path**: Backend scrap/sell tests → Frontend storage tests → Final verification

---

## Context

### Original Request
User wants comprehensive test coverage for v2.7.0 features plus critical gaps from previous updates.

### Interview Summary
**Key Discussions**:
- Test level: Backend + Frontend component tests (no E2E)
- Previous features: Fill critical gaps only
- Frontend approach: Vitest component tests, co-located in `__tests__/`

**Research Findings**:
- Backend has 426 tests, comprehensive fixtures, but ZERO scrap/sell tests
- Frontend has 40 test files but ZERO storage tests
- Factories exist for all item types
- Test patterns well-established in existing files

### Metis Review
**Identified Gaps** (addressed):
- Junk pricing: Assert exact values (2/50/200 caps)
- Scrap randomness: Test real behavior, verify junk created
- Frontend location: Co-locate in `src/modules/*/__tests__/`
- Equipment store: Test both API and store filtering

---

## Work Objectives

### Core Objective
Create comprehensive test coverage for v2.7.0 storage management system (scrap/sell/filtering) and fill critical testing gaps from previous versions to meet project coverage goals (>80% backend, >70% frontend).

### Concrete Deliverables
- `backend/app/tests/test_api/test_storage.py` - Enhanced with items endpoint tests
- `backend/app/tests/test_api/test_weapon.py` - Enhanced with scrap/sell tests
- `backend/app/tests/test_api/test_outfit.py` - Enhanced with scrap/sell tests
- `backend/app/tests/test_api/test_junk.py` - Enhanced with sell tests
- `frontend/src/modules/storage/__tests__/storageService.test.ts` - New
- `frontend/src/modules/storage/__tests__/components/StorageItemCard.test.ts` - New
- `frontend/src/modules/storage/__tests__/views/StorageView.test.ts` - New
- `frontend/src/modules/combat/__tests__/stores/equipment.test.ts` - New

### Definition of Done
- [ ] All v2.7.0 endpoints have test coverage
- [ ] Backend coverage >80% for storage/scrap/sell modules
- [ ] Frontend storage components have >70% coverage
- [ ] `uv run pytest backend/app/tests/test_api/test_weapon.py` → ALL PASS
- [ ] `uv run pytest backend/app/tests/test_api/test_outfit.py` → ALL PASS
- [ ] `uv run pytest backend/app/tests/test_api/test_junk.py` → ALL PASS
- [ ] `uv run pytest backend/app/tests/test_api/test_storage.py` → ALL PASS
- [ ] `pnpm test storage` → ALL PASS (frontend)
- [ ] No regression in existing 426 tests

### Must Have
- Tests for all scrap/sell endpoints
- Tests for junk pricing system
- Tests for equipment vault filtering
- Tests for storage items endpoint
- Frontend tests for StorageItemCard
- Frontend tests for storage service

### Must NOT Have (Guardrails)
- E2E tests (out of scope for this plan)
- Tests for v2.8.0 features (easter eggs)
- Tests for visual-only UI polish
- Integration tests spanning multiple modules
- Performance/load tests
- Probability distribution tests for scrap randomness

---

## Verification Strategy

### Test Decision
- **Infrastructure exists**: YES (pytest backend, vitest frontend)
- **User wants tests**: Tests-after (implementation complete, now adding tests)
- **Framework**: pytest (backend), vitest + @vue/test-utils (frontend)

### Backend Tests - API Integration Pattern

Each backend test follows this pattern:

**Test Structure:**
1. **Setup**: Create vault, storage, and items using factories
2. **Execute**: Call API endpoint via async_client
3. **Assert**: Verify response status, structure, and database state

**Example from existing test_storage.py:**
```python
async def test_get_storage_space_info(
    async_client: AsyncClient,
    async_session: AsyncSession,
    superuser_token_headers: dict[str, str],
):
    # Setup
    vault = await create_vault_with_storage(async_session)

    # Execute
    response = await async_client.get(
        f"/storage/vault/{vault.id}/space",
        headers=superuser_token_headers,
    )

    # Assert
    assert response.status_code == 200
    assert "used_space" in response.json()
```

**Verification Commands:**
- `cd backend && uv run pytest app/tests/test_api/test_weapon.py -v`
- `cd backend && uv run pytest app/tests/test_api/ -k "scrap or sell" -v`
- `cd backend && uv run pytest --cov=app/api/v1/endpoints --cov=app/crud`

### Frontend Tests - Component Unit Pattern

Each frontend test follows Vue Test Utils pattern:

**Test Structure:**
```typescript
import { mount } from '@vue/test-utils'
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { createPinia, setActivePinia } from 'pinia'

describe('StorageItemCard', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('renders weapon details correctly', () => {
    const wrapper = mount(StorageItemCard, {
      props: { item: mockWeapon, itemType: 'weapon' }
    })
    expect(wrapper.find('.item-name').text()).toBe('Pistol')
  })
})
```

**Verification Commands:**
- `cd frontend && pnpm test storage`
- `cd frontend && pnpm test -- --coverage`
- `cd frontend && pnpm test StorageItemCard`

---

## Execution Strategy

### Parallel Execution Waves

```
Wave 1 (Backend Tests - Start Immediately):
├── Task 1: Storage items endpoint tests
├── Task 2: Weapon scrap/sell tests
├── Task 3: Outfit scrap/sell tests
└── Task 4: Junk sell tests

Wave 2 (Frontend Tests - After Wave 1):
├── Task 5: Storage service tests
├── Task 6: StorageItemCard component tests
├── Task 7: StorageView component tests
└── Task 8: Equipment store vault filtering tests

Wave 3 (Verification - After Wave 2):
└── Task 9: Run all tests and verify coverage

Critical Path: Task 2 → Task 6 → Task 9
Parallel Speedup: ~40% faster than sequential
```

### Dependency Matrix

| Task | Depends On | Blocks | Can Parallelize With |
|------|------------|--------|---------------------|
| 1 | None | None | 2, 3, 4 |
| 2 | None | 6 | 1, 3, 4 |
| 3 | None | None | 1, 2, 4 |
| 4 | None | None | 1, 2, 3 |
| 5 | 1-4 complete | None | 6, 7, 8 |
| 6 | 2 complete | 9 | 5, 7, 8 |
| 7 | 1-4 complete | 9 | 5, 6, 8 |
| 8 | 1-4 complete | None | 5, 6, 7 |
| 9 | 5-8 complete | None | None (final) |

### Agent Dispatch Summary

| Wave | Tasks | Recommended Agents |
|------|-------|-------------------|
| 1 | 1-4 | 4x delegate_task(category="quick", run_in_background=true) |
| 2 | 5-8 | 4x delegate_task(category="quick", run_in_background=true) |
| 3 | 9 | delegate_task(category="quick", run_in_background=false) |

---

## TODOs

- [ ] 1. Add Storage Items Endpoint Tests

  **What to do**:
  - Add test file: `backend/app/tests/test_api/test_storage.py` (enhance existing)
  - Test `GET /storage/vault/{vault_id}/items` endpoint
  - Test cases:
    - Returns weapons, outfits, junk for vault
    - Filters by vault's storage_id
    - Excludes equipped items from other vaults
    - Returns empty arrays when storage is empty
    - Requires authentication
    - Returns 403 for other user's vault

  **Must NOT do**:
  - Don't duplicate existing storage space tests
  - Don't test storage CRUD methods directly (only API)

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Single test file enhancement, clear pattern to follow from existing tests
  - **Skills**: []
    - Reason: No special skills needed, standard pytest patterns

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1 (with Tasks 2, 3, 4)
  - **Blocks**: None
  - **Blocked By**: None (can start immediately)

  **References**:

  **Pattern References** (existing code to follow):
  - `backend/app/tests/test_api/test_storage.py:18-54` - Existing storage space test pattern (setup vault, call API, assert response)
  - `backend/app/tests/test_api/test_storage.py:147-171` - Authorization test pattern (test 403 for wrong user)

  **API Reference**:
  - `backend/app/api/v1/endpoints/storage.py:62-113` - Storage items endpoint implementation
  - `backend/app/schemas/storage.py` - StorageItemsResponse schema (weapons, outfits, junk arrays)

  **Factory References**:
  - `backend/app/tests/factory/items.py:11-18` - create_fake_junk() factory
  - `backend/app/tests/factory/items.py:31-41` - create_fake_weapon() factory
  - `backend/app/tests/factory/items.py:21-28` - create_fake_outfit() factory
  - `backend/app/tests/factory/vaults.py` - create_fake_vault() factory

  **Test count**: Aim for ~6 test cases

  **Acceptance Criteria**:
  - [ ] Test file enhanced: `backend/app/tests/test_api/test_storage.py`
  - [ ] Test: `test_get_storage_items_success` - Returns all item types
  - [ ] Test: `test_get_storage_items_empty` - Returns empty arrays
  - [ ] Test: `test_get_storage_items_filters_by_vault` - Only returns vault's items
  - [ ] Test: `test_get_storage_items_unauthorized` - Returns 401
  - [ ] Test: `test_get_storage_items_forbidden` - Returns 403 for other user
  - [ ] Test: `test_get_storage_items_not_found` - Returns 404 for invalid vault
  - [ ] Command: `uv run pytest backend/app/tests/test_api/test_storage.py::test_get_storage_items_success -v` → PASS
  - [ ] All new tests pass with `uv run pytest backend/app/tests/test_api/test_storage.py -v`

  **Commit**: YES
  - Message: `test(storage): add storage items endpoint tests`
  - Files: `backend/app/tests/test_api/test_storage.py`
  - Pre-commit: `uv run pytest backend/app/tests/test_api/test_storage.py`

---

- [x] 2. Add Weapon Scrap/Sell Endpoint Tests

  **What to do**:
  - Enhance: `backend/app/tests/test_api/test_weapon.py`
  - Test `POST /weapons/{id}/scrap/` endpoint:
    - Returns junk items array
    - Deletes original weapon from database
    - Junk items assigned to same storage_id
    - Junk items have correct rarity-based values
  - Test `POST /weapons/{id}/sell/` endpoint:
    - Deletes weapon from database
    - Adds caps to vault (based on weapon value)
    - Returns 404 for non-existent weapon
    - Requires authentication
  - Test equipment vault filtering:
    - `GET /weapons/?vault_id={id}` returns only vault's weapons
    - Includes items in storage AND equipped by vault dwellers
    - Excludes weapons from other vaults

  **Must NOT do**:
  - Don't test probability distribution of scrap junk
  - Don't test existing CRUD operations (already covered)

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Single test file, clear API patterns
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1 (with Tasks 1, 3, 4)
  - **Blocks**: Task 6 (frontend needs backend scrap working)
  - **Blocked By**: None

  **References**:

  **Pattern References**:
  - `backend/app/tests/test_api/test_weapon.py:12-24` - Existing weapon CRUD test pattern
  - `backend/app/tests/test_api/test_storage.py:18-54` - Database state verification pattern

  **API Implementation**:
  - `backend/app/api/v1/endpoints/weapon.py:94-96` - Scrap endpoint
  - `backend/app/api/v1/endpoints/weapon.py:99-101` - Sell endpoint
  - `backend/app/api/v1/endpoints/weapon.py:21-47` - Vault filtering logic
  - `backend/app/crud/item_base.py:198-222` - Scrap CRUD method (creates junk with storage_id)
  - `backend/app/crud/item_base.py:235-260` - Sell CRUD method (adds caps, deletes item)

  **Factory References**:
  - `backend/app/tests/factory/items.py:31-41` - create_fake_weapon()
  - `backend/app/tests/factory/vaults.py` - create_fake_vault()

  **Test count**: Aim for ~10 test cases

  **Acceptance Criteria**:
  - [ ] Test: `test_scrap_weapon_success` - Returns junk array, deletes weapon
  - [ ] Test: `test_scrap_weapon_assigns_storage_id` - Junk has same storage_id
  - [ ] Test: `test_scrap_weapon_creates_correct_value` - Junk value matches rarity (2/50/200)
  - [ ] Test: `test_scrap_weapon_not_found` - Returns 404
  - [ ] Test: `test_sell_weapon_success` - Deletes weapon, adds caps
  - [ ] Test: `test_sell_weapon_adds_correct_caps` - Vault caps += weapon.value
  - [ ] Test: `test_sell_weapon_not_found` - Returns 404
  - [ ] Test: `test_filter_weapons_by_vault` - Returns only vault's weapons
  - [ ] Test: `test_filter_weapons_includes_equipped` - Includes dweller-equipped items
  - [ ] Test: `test_filter_weapons_excludes_other_vaults` - No cross-vault contamination
  - [ ] Command: `uv run pytest backend/app/tests/test_api/test_weapon.py -v` → ALL PASS

  **Commit**: YES
  - Message: `test(weapon): add scrap/sell/vault-filtering tests`
  - Files: `backend/app/tests/test_api/test_weapon.py`
  - Pre-commit: `uv run pytest backend/app/tests/test_api/test_weapon.py`

---

- [ ] 3. Add Outfit Scrap/Sell Endpoint Tests

  **What to do**:
  - Enhance: `backend/app/tests/test_api/test_outfit.py`
  - Test `POST /outfits/{id}/scrap/` endpoint:
    - Returns junk items array
    - Deletes original outfit
    - Junk items assigned to storage
    - Junk value based on rarity
  - Test `POST /outfits/{id}/sell/` endpoint:
    - Deletes outfit
    - Adds caps to vault
    - Returns 404 for missing outfit
  - Test vault filtering:
    - `GET /outfits/?vault_id={id}` returns vault's outfits only
    - Includes equipped outfits

  **Must NOT do**:
  - Don't test existing outfit CRUD (already covered)
  - Don't test scrap probability details

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Mirror of weapon tests, same patterns
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1 (with Tasks 1, 2, 4)
  - **Blocks**: None
  - **Blocked By**: None

  **References**:

  **Pattern References**:
  - `backend/app/tests/test_api/test_outfit.py` - Existing outfit test patterns
  - Will reference Task 2 (weapon tests) for scrap/sell patterns

  **API Implementation**:
  - `backend/app/api/v1/endpoints/outfit.py:81-83` - Scrap endpoint
  - `backend/app/api/v1/endpoints/outfit.py:86-88` - Sell endpoint
  - `backend/app/api/v1/endpoints/outfit.py:21-47` - Vault filtering
  - `backend/app/crud/item_base.py` - Shared scrap/sell logic

  **Test count**: Aim for ~10 test cases

  **Acceptance Criteria**:
  - [ ] Test: `test_scrap_outfit_success` - Returns junk, deletes outfit
  - [ ] Test: `test_scrap_outfit_storage_assignment` - Junk has storage_id
  - [ ] Test: `test_scrap_outfit_junk_pricing` - Common=2, Rare=50, Legendary=200
  - [ ] Test: `test_sell_outfit_success` - Deletes outfit, adds caps
  - [ ] Test: `test_sell_outfit_caps_calculation` - Correct caps added
  - [ ] Test: `test_filter_outfits_by_vault` - Vault filtering works
  - [ ] Test: `test_filter_outfits_includes_equipped` - Equipped items included
  - [ ] Command: `uv run pytest backend/app/tests/test_api/test_outfit.py -v` → ALL PASS

  **Commit**: YES
  - Message: `test(outfit): add scrap/sell/vault-filtering tests`
  - Files: `backend/app/tests/test_api/test_outfit.py`
  - Pre-commit: `uv run pytest backend/app/tests/test_api/test_outfit.py`

---

- [ ] 4. Add Junk Sell Endpoint Tests

  **What to do**:
  - Enhance: `backend/app/tests/test_api/test_junk.py`
  - Test `POST /junk/{id}/sell/` endpoint:
    - Deletes junk from database
    - Adds caps to vault (based on junk value)
    - Junk value correct based on rarity (2/50/200)
    - Returns 404 for non-existent junk
    - Requires authentication
  - Test junk pricing system:
    - Common junk has value=2
    - Rare junk has value=50
    - Legendary junk has value=200

  **Must NOT do**:
  - Don't test scrap (junk can't be scrapped)
  - Don't test existing junk CRUD

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Straightforward sell tests
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1 (with Tasks 1, 2, 3)
  - **Blocks**: None
  - **Blocked By**: None

  **References**:

  **Pattern References**:
  - `backend/app/tests/test_api/test_junk.py:15-24` - Existing junk CRUD pattern
  - Will reference Task 2 sell tests for pattern

  **API Implementation**:
  - `backend/app/api/v1/endpoints/junk.py:44-46` - Sell endpoint
  - `backend/app/crud/item_base.py:235-260` - Sell method
  - `backend/app/models/junk.py:18-22` - Junk pricing by rarity

  **Migration Reference**:
  - `backend/app/alembic/versions/2026_01_27_2011-59eb893b6170_fix_junk_item_values.py` - Junk pricing migration

  **Test count**: Aim for ~6 test cases

  **Acceptance Criteria**:
  - [ ] Test: `test_sell_junk_success` - Deletes junk, adds caps
  - [ ] Test: `test_sell_junk_common_value` - Common junk sells for 2 caps
  - [ ] Test: `test_sell_junk_rare_value` - Rare junk sells for 50 caps
  - [ ] Test: `test_sell_junk_legendary_value` - Legendary sells for 200 caps
  - [ ] Test: `test_sell_junk_not_found` - Returns 404
  - [ ] Test: `test_sell_junk_unauthorized` - Returns 401
  - [ ] Command: `uv run pytest backend/app/tests/test_api/test_junk.py::test_sell_junk_success -v` → PASS

  **Commit**: YES
  - Message: `test(junk): add sell tests with pricing verification`
  - Files: `backend/app/tests/test_api/test_junk.py`
  - Pre-commit: `uv run pytest backend/app/tests/test_api/test_junk.py`

---

- [ ] 5. Create Storage Service Tests (Frontend)

  **What to do**:
  - Create: `frontend/src/modules/storage/__tests__/storageService.test.ts`
  - Test storage service methods:
    - `getStorageSpace(vaultId)` - Calls correct endpoint
    - `getStorageItems(vaultId)` - Returns weapons/outfits/junk
    - `sellWeapon(weaponId)` - Calls POST /weapons/{id}/sell/
    - `sellOutfit(outfitId)` - Calls POST /outfits/{id}/sell/
    - `sellJunk(junkId)` - Calls POST /junk/{id}/sell/
    - `scrapWeapon(weaponId)` - Calls POST /weapons/{id}/scrap/
    - `scrapOutfit(outfitId)` - Calls POST /outfits/{id}/scrap/
  - Mock axios calls with vi.mock()

  **Must NOT do**:
  - Don't test actual API (backend tests cover that)
  - Don't test component integration

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Service layer tests, straightforward mocking
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 6, 7, 8)
  - **Blocks**: None
  - **Blocked By**: Tasks 1-4 (backend tests should pass first)

  **References**:

  **Pattern References**:
  - `frontend/tests/unit/modules/combat/stores/equipment.test.ts` - Existing store test pattern
  - Use `vi.mock('@/core/plugins/axios')` for API mocking

  **Implementation Reference**:
  - `frontend/src/modules/storage/services/storageService.ts:1-68` - Service to test

  **Test Framework**:
  - Vitest with `describe`, `it`, `expect`, `vi.mock()`

  **Test count**: Aim for ~8 test cases

  **Acceptance Criteria**:
  - [ ] Created: `frontend/src/modules/storage/__tests__/storageService.test.ts`
  - [ ] Test: `getStorageSpace calls correct endpoint`
  - [ ] Test: `getStorageItems returns items`
  - [ ] Test: `sellWeapon calls POST endpoint`
  - [ ] Test: `sellOutfit calls POST endpoint`
  - [ ] Test: `sellJunk calls POST endpoint`
  - [ ] Test: `scrapWeapon calls POST endpoint`
  - [ ] Test: `scrapOutfit calls POST endpoint`
  - [ ] Test: Error handling for failed API calls
  - [ ] Command: `pnpm test storage/storageService` → 8 tests PASS

  **Commit**: YES
  - Message: `test(storage): add storageService unit tests`
  - Files: `frontend/src/modules/storage/__tests__/storageService.test.ts`
  - Pre-commit: `pnpm test storage/storageService`

---

- [ ] 6. Create StorageItemCard Component Tests

  **What to do**:
  - Create: `frontend/src/modules/storage/__tests__/components/StorageItemCard.test.ts`
  - Test component rendering:
    - Renders weapon with correct name, damage, stats
    - Renders outfit with correct name, type, gender
    - Renders junk with correct name, type
    - Shows count badge when count > 1
    - Shows rarity color correctly
  - Test user interactions:
    - Emits 'sell' event when Sell clicked
    - Emits 'sellAll' event when Sell All clicked
    - Emits 'scrap' event when Scrap clicked
    - Scrap button only shows for weapons/outfits
    - Sell All button only shows when count > 1

  **Must NOT do**:
  - Don't test actual API calls (service tests cover that)
  - Don't test parent component integration

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Component unit test, standard Vue Test Utils
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 5, 7, 8)
  - **Blocks**: Task 9
  - **Blocked By**: Task 2 (needs scrap logic to exist)

  **References**:

  **Pattern References**:
  - `frontend/tests/unit/modules/dwellers/components/DwellerEquipment.test.ts` - Component test pattern
  - Use `mount()` from @vue/test-utils
  - Use `vi.fn()` for prop functions

  **Implementation Reference**:
  - `frontend/src/modules/storage/components/StorageItemCard.vue:1-382` - Component to test

  **Test Framework**:
  - `@vue/test-utils` for mounting
  - `vitest` for assertions

  **Test count**: Aim for ~12 test cases

  **Acceptance Criteria**:
  - [ ] Created: `frontend/src/modules/storage/__tests__/components/StorageItemCard.test.ts`
  - [ ] Test: Renders weapon name and damage range
  - [ ] Test: Renders outfit name and type
  - [ ] Test: Renders junk name
  - [ ] Test: Shows count badge when count > 1
  - [ ] Test: Hides count badge when count = 1
  - [ ] Test: Emits sell event on button click
  - [ ] Test: Emits sellAll event on Sell All click
  - [ ] Test: Emits scrap event on Scrap click
  - [ ] Test: Scrap button hidden for junk
  - [ ] Test: Scrap button visible for weapon/outfit
  - [ ] Test: Sell All button visible when count > 1
  - [ ] Test: Sell All button hidden when count = 1
  - [ ] Command: `pnpm test StorageItemCard` → 12 tests PASS

  **Commit**: YES
  - Message: `test(storage): add StorageItemCard component tests`
  - Files: `frontend/src/modules/storage/__tests__/components/StorageItemCard.test.ts`
  - Pre-commit: `pnpm test StorageItemCard`

---

- [ ] 7. Create StorageView Component Tests

  **What to do**:
  - Create: `frontend/src/modules/storage/__tests__/views/StorageView.test.ts`
  - Test component rendering:
    - Renders storage space progress bar
    - Renders tabs (weapons/outfits/junk)
    - Shows correct item count per tab
    - Renders items grid
  - Test user interactions:
    - Tab switching updates activeTab
    - Calls fetchStorageData on mount
    - Handles sell item (calls service, refreshes)
    - Handles scrap item (calls service, refreshes)
    - Handles sell all (calls service for each ID)
  - Test junk grouping:
    - Groups junk by name+rarity
    - Calculates correct counts
    - Passes grouped data to cards

  **Must NOT do**:
  - Don't test actual API (mock storageService)
  - Don't test child component rendering details

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: View component test, standard patterns
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 5, 6, 8)
  - **Blocks**: Task 9
  - **Blocked By**: Tasks 1-4 (backend should work)

  **References**:

  **Pattern References**:
  - Existing view test patterns from frontend/tests/unit/
  - Mock storageService with `vi.mock()`
  - Mock useRoute with `vi.mocked(useRoute)`

  **Implementation Reference**:
  - `frontend/src/modules/storage/views/StorageView.vue:1-500` - View to test
  - `frontend/src/modules/storage/services/storageService.ts` - Service to mock

  **Test count**: Aim for ~10 test cases

  **Acceptance Criteria**:
  - [ ] Created: `frontend/src/modules/storage/__tests__/views/StorageView.test.ts`
  - [ ] Test: Renders storage space info
  - [ ] Test: Renders three tabs
  - [ ] Test: Tab click changes activeTab
  - [ ] Test: Calls fetchStorageData on mount
  - [ ] Test: Groups junk items correctly
  - [ ] Test: Junk grouping counts duplicates
  - [ ] Test: handleSellItem calls service
  - [ ] Test: handleScrapItem calls service
  - [ ] Test: handleSellItem with array calls service multiple times
  - [ ] Test: Refreshes data after sell/scrap
  - [ ] Command: `pnpm test StorageView` → 10 tests PASS

  **Commit**: YES
  - Message: `test(storage): add StorageView component tests`
  - Files: `frontend/src/modules/storage/__tests__/views/StorageView.test.ts`
  - Pre-commit: `pnpm test StorageView`

---

- [ ] 8. Create Equipment Store Vault Filtering Tests

  **What to do**:
  - Create: `frontend/src/modules/combat/__tests__/stores/equipment.test.ts`
  - Test store actions:
    - `fetchWeapons(token, vaultId)` - Calls API with vault_id param
    - `fetchOutfits(token, vaultId)` - Calls API with vault_id param
    - `getAvailableWeapons()` - Filters by !dweller_id
    - `getAvailableOutfits()` - Filters by !dweller_id
  - Test vault filtering:
    - When vaultId provided, passes to API
    - When vaultId missing, fetches all

  **Must NOT do**:
  - Don't test equip/unequip (existing functionality)
  - Don't test backend filtering logic

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Store test, standard Pinia patterns
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 5, 6, 7)
  - **Blocks**: None
  - **Blocked By**: Tasks 1-4

  **References**:

  **Pattern References**:
  - `frontend/tests/unit/` - Existing store test patterns
  - Use `setActivePinia(createPinia())` before tests

  **Implementation Reference**:
  - `frontend/src/modules/combat/stores/equipment.ts:1-158` - Store to test
  - `frontend/src/modules/combat/services/equipment.ts` - Service to mock

  **Test count**: Aim for ~6 test cases

  **Acceptance Criteria**:
  - [ ] Created: `frontend/src/modules/combat/__tests__/stores/equipment.test.ts`
  - [ ] Test: fetchWeapons calls service with vaultId
  - [ ] Test: fetchOutfits calls service with vaultId
  - [ ] Test: fetchWeapons without vaultId calls service without param
  - [ ] Test: getAvailableWeapons filters unequipped
  - [ ] Test: getAvailableOutfits filters unequipped
  - [ ] Test: Error handling updates error state
  - [ ] Command: `pnpm test equipment.test` → 6 tests PASS

  **Commit**: YES
  - Message: `test(equipment): add store vault filtering tests`
  - Files: `frontend/src/modules/combat/__tests__/stores/equipment.test.ts`
  - Pre-commit: `pnpm test equipment.test`

---

- [ ] 9. Run Full Test Suite and Verify Coverage

  **What to do**:
  - Run all backend tests: `uv run pytest -v`
  - Run all frontend tests: `pnpm test`
  - Check backend coverage: `uv run pytest --cov=app --cov-report=term`
  - Check frontend coverage: `pnpm test -- --coverage`
  - Verify no regressions in existing 426 tests
  - Document coverage improvements

  **Must NOT do**:
  - Don't skip failing tests
  - Don't commit if any tests fail

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Verification task, run commands and report
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Parallel Group**: Wave 3 (Sequential - final verification)
  - **Blocks**: None (final task)
  - **Blocked By**: Tasks 5-8 (all tests must be written)

  **References**:

  **Commands**:
  - Backend: `cd backend && uv run pytest -v --cov=app --cov-report=term-missing`
  - Frontend: `cd frontend && pnpm test -- --coverage`

  **Test count**: ~426 + 49 new tests = 475 total

  **Acceptance Criteria**:
  - [ ] Backend tests: `uv run pytest -v` → 426+ tests PASS, 0 FAIL
  - [ ] Frontend tests: `pnpm test` → 48+ tests PASS, 0 FAIL
  - [ ] Backend coverage: >80% for storage/weapon/outfit/junk modules
  - [ ] Frontend coverage: >15% overall (new tests added)
  - [ ] No regressions in existing tests
  - [ ] Coverage report shows improvements in:
    - app/api/v1/endpoints/storage.py
    - app/api/v1/endpoints/weapon.py
    - app/api/v1/endpoints/outfit.py
    - app/api/v1/endpoints/junk.py
    - app/crud/item_base.py
    - frontend/src/modules/storage/

  **Commit**: YES
  - Message: `chore: verify test coverage for v2.7.0`
  - Files: (none - just verification)
  - Pre-commit: All tests must pass

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 1 | `test(storage): add storage items endpoint tests` | test_storage.py | `pytest test_storage.py` |
| 2 | `test(weapon): add scrap/sell/vault-filtering tests` | test_weapon.py | `pytest test_weapon.py` |
| 3 | `test(outfit): add scrap/sell/vault-filtering tests` | test_outfit.py | `pytest test_outfit.py` |
| 4 | `test(junk): add sell tests with pricing verification` | test_junk.py | `pytest test_junk.py` |
| 5 | `test(storage): add storageService unit tests` | storageService.test.ts | `pnpm test storageService` |
| 6 | `test(storage): add StorageItemCard component tests` | StorageItemCard.test.ts | `pnpm test StorageItemCard` |
| 7 | `test(storage): add StorageView component tests` | StorageView.test.ts | `pnpm test StorageView` |
| 8 | `test(equipment): add store vault filtering tests` | equipment.test.ts | `pnpm test equipment` |
| 9 | `chore: verify test coverage for v2.7.0` | (none) | All tests pass |

---

## Success Criteria

### Verification Commands
```bash
# Backend - All tests pass
cd backend && uv run pytest -v

# Backend - Coverage report
cd backend && uv run pytest --cov=app --cov-report=term-missing

# Frontend - All tests pass
cd frontend && pnpm test

# Frontend - Coverage report
cd frontend && pnpm test -- --coverage

# Specific test suites
uv run pytest backend/app/tests/test_api/test_storage.py -v
uv run pytest backend/app/tests/test_api/test_weapon.py -v
uv run pytest backend/app/tests/test_api/test_outfit.py -v
uv run pytest backend/app/tests/test_api/test_junk.py -v
pnpm test storage
pnpm test equipment
```

### Final Checklist
- [ ] All 8 backend test files pass
- [ ] All 4 frontend test files pass
- [ ] Backend coverage >80% for modified modules
- [ ] Frontend coverage >15% overall (baseline established)
- [ ] Zero regressions in existing 426 backend tests
- [ ] All new tests follow established patterns
- [ ] All commits have passing pre-commit hooks
- [ ] Coverage report shows improvements in all v2.7.0 modules
