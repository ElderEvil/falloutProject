# v2.8.5 — Refund correctness + UI/security hardening + test isolation

## TL;DR

Persist the **paid build price** for rooms so destroy refunds can return **50% of what was actually paid**, expose refund metadata from the destroy API for the UI, harden a few frontend security/a11y/robustness issues, and fix unit test flakiness caused by module-scoped composable state.

**Deliverables**
- Backend: `Room.build_price` (paid build price) + Alembic migration + best-effort backfill.
- Backend: `/api/v1/rooms/destroy/{room_id}` returns refund metadata (e.g., `refund_caps`, `refund_rate`).
- Backend: refund calculation uses stored paid build price (plus paid upgrades inferred from tier/cost fields).
- Frontend: Room destroy toast uses backend-provided refund metadata (no hardcoded “50%”).
- Frontend: `FakeCrashOverlay.vue` async sequence is cancellation-safe when `props.show` toggles quickly.
- Frontend: `ChangelogModal.vue` window.open hardened against tabnabbing.
- Frontend: `AboutView.vue` version click is keyboard accessible (semantic button).
- Frontend: `RoomDetailModal.vue` avoids invalid Authorization header when token is missing.
- Tests: stabilize `useFakeCrash` and `useGaryMode` unit tests by resetting module-scoped refs via public API.

**Estimated Effort**: Medium
**Parallel Execution**: YES — 2 waves
**Critical Path**: Backend migration/refund API → Frontend destroyRoom/toast update → Tests

---

## Context

### Original Request
- Backend room destroy refund currently under-refunds when incremental pricing scales; fix to refund 50% of actual paid build price.
- Multiple frontend issues: async overlap in FakeCrashOverlay, tabnabbing risk, a11y for AboutView version click, remove hardcoded “50%” text, guard auth token usage.
- Fix test flakiness due to module-level singleton refs in composables.

### Key Findings (verified)

**Backend mismatch (build price vs refund)**
- Build price charged at build time:
  - `backend/app/crud/room.py:65-80` — `get_room_build_price()` computes `base_cost + (len(rooms_in_category) * incremental_cost)`
  - `backend/app/crud/room.py:183-185` — `build()` withdraws caps using that computed price
- Refund credited at destroy time:
  - `backend/app/crud/room.py:261-272` — uses `base_cost + incremental_cost (+ upgrades)` then `int(* 0.5)`
  - This ignores ordinal multiplier and cannot be reconstructed reliably because rooms are hard-deleted.

**Room model missing paid-price field**
- `backend/app/models/room.py:19-22` has `base_cost`, `incremental_cost`, upgrade costs; no `build_price`/paid-cost.

**Hard-delete destroys pricing history**
- `backend/app/crud/base.py:211-240` — Room uses hard delete path; destroyed rooms disappear.

**Frontend references**
- Destroy toast hardcodes percent:
  - `frontend/src/modules/rooms/components/RoomDetailModal.vue:260`
- Room store destroy API is `axios.delete` and currently assumes 204:
  - `frontend/src/modules/rooms/stores/room.ts:67-85`
- `loadRadioStats` builds Authorization from possibly-null token:
  - `frontend/src/modules/rooms/components/RoomDetailModal.vue:345-358` (header on `:350`)
- Fake crash async overlap:
  - `frontend/src/core/components/easter-eggs/FakeCrashOverlay.vue:46-74`
- ChangelogModal `window.open`:
  - `frontend/src/modules/profile/components/ChangelogModal.vue:81-86`
- AboutView clickable span:
  - `frontend/src/modules/profile/views/AboutView.vue:62-67`
- Composable test leak sources:
  - `frontend/src/core/composables/useFakeCrash.ts:8-12` module-scoped refs/timer
  - `frontend/src/core/composables/useGaryMode.ts:7-10` module-scoped refs/timer

---

## Work Objectives

### Core Objective
Refund destroys as **50% of the paid build price** (and paid upgrades), with the UI displaying backend-truth refund info.

### Definition of Done
- [ ] Backend migration applied and backfill complete.
- [ ] Destroy endpoint returns refund metadata and refunds correct caps.
- [ ] Frontend consumes refund metadata; no hardcoded refund percent.
- [ ] Frontend fixes for cancellation/tabnabbing/a11y/token-guard implemented.
- [ ] Backend tests pass; frontend tests pass.

### Guardrails
- Do **not** change room build pricing formula semantics (still counts by `category` as currently implemented).
- Do **not** introduce new npm dependencies for these fixes.
- Do **not** make unrelated sweeping a11y/security refactors.
- Keep migrations additive and safe (nullable first, then tighten if appropriate).

---

## Verification Strategy

### Test Decision
- Infrastructure exists: YES
  - Backend: pytest + ruff
  - Frontend: vitest + oxlint
- Strategy: **Tests-after**

### Commands (agent-executable)

Backend:
```bash
cd backend
uv run ruff check .
uv run ruff format --check .
uv run alembic upgrade head
uv run pytest app/tests/
```

Frontend:
```bash
cd frontend
pnpm run lint
pnpm test
```

---

## Execution Strategy

### Wave 1 (can run in parallel)
- Backend: add persisted paid build price + migration/backfill + destroy refund metadata
- Frontend: FakeCrashOverlay cancellation
- Frontend: ChangelogModal noopener/noreferrer
- Frontend: AboutView version button a11y

### Wave 2 (depends on Wave 1 backend)
- Frontend: update room store + RoomDetailModal toast to consume refund metadata
- Frontend: RoomDetailModal auth token guard for loadRadioStats
- Tests: update failing/flaky unit tests (`useFakeCrash`, `useGaryMode`) and add minimal regression tests

---

## TODOs

### 1) Backend: annotate refund rate constant

**What to do**
- In `backend/app/crud/room.py:18`, change to `DESTROY_ROOM_REFUND_RATE: float = 0.5`.

**References**
- `backend/app/crud/room.py:18`

**Acceptance Criteria**
- `uv run ruff check backend/app/crud/room.py` → PASS

---

### 2) Backend: persist paid build price on Room (schema + migration)

**What to do**
- Add a new column on `Room` model: `build_price: int | None` (nullable for safe rollout).
- Create Alembic migration to add column.
- Ensure new rooms built via `CRUDRoom.build()` get `build_price` set to the computed price at build time.
- Ensure refund logic uses `build_price` when present.

**Why**
- Hard deletes prevent reconstructing build-time ordinal later; storing paid price is required to refund what was actually paid.

**References**
- `backend/app/models/room.py:14-33` (existing cost fields)
- `backend/app/crud/room.py:65-80` (`get_room_build_price`)
- `backend/app/crud/room.py:183-185` (withdraw caps during build)

**Acceptance Criteria**
- Alembic migration applies: `uv run alembic upgrade head` → PASS
- A newly built room row has non-null `build_price` equal to charged price.

---

### 3) Backend: best-effort backfill for legacy rooms

**What to do**
- In migration (or a one-time backfill routine invoked by migration), fill `Room.build_price` for existing rooms using:
  - group by `(vault_id, category)`
  - order by `created_at` (and tie-breaker by `id` if needed)
  - compute ordinal index within group
  - estimate `build_price = base_cost + (ordinal * incremental_cost)` (treat null incremental as 0)
- Document in migration comments: backfill is best-effort; hard-deletes mean missing history.

**References**
- `backend/app/schemas/room.py:19-22` indicates `created_at` exists on API model
- `backend/app/models/room.py` uses `TimeStampMixin` (created_at available)
- `backend/app/crud/base.py:211-240` (hard delete implies imperfect backfill)

**Acceptance Criteria**
- After migration, existing rooms have `build_price` populated (non-null) unless explicitly excluded.

---

### 4) Backend: destroy refund uses stored paid build price + returns refund metadata

**What to do**
- Update `CRUDRoom.destroy()` refund calculation:
  - Compute `refundable_total = (db_obj.build_price ?? estimated_fallback) + paid_upgrades`
  - `paid_upgrades` inferred from tier + `t2_upgrade_cost`/`t3_upgrade_cost` stored on the room row.
  - Refund amount uses consistent rounding. (Default: keep current `int(...)` truncation behavior unless changed.)
- Return a structured response from the destroy endpoint, e.g.:
  - `{ "refund_caps": <int>, "refund_rate": 0.5 }`
- Update API endpoint in `backend/app/api/v1/endpoints/room.py` currently returning 204 to return this JSON.

**References**
- `backend/app/crud/room.py:241-279` (destroy + refund + deposit)
- `backend/app/crud/vault.py:271-274` (`deposit_caps`)
- `backend/app/api/v1/endpoints/room.py:116-129` (destroy endpoint wiring)

**Acceptance Criteria**
- Unit/integration test validates refund correctness:
  - Build 2+ rooms in same `(vault_id, category)` so ordinal differs
  - Destroy later room and assert refunded caps == `int((build_price + paid_upgrades) * 0.5)`
- Destroy endpoint returns JSON with `refund_caps` int and `refund_rate` 0.5.

---

### 5) Frontend: FakeCrashOverlay cancellation-safe async flow

**What to do**
- Add a run token / cancellation mechanism so overlapping `simulateCrash()` runs cannot interleave state changes or emit stale completion.
- Recommended minimal pattern: watcher increments a `runId`; `simulateCrash` and `typewriterEffect` capture `myRun` and bail out before each await if stale.
- Ensure watcher `else` branch (show=false) invalidates runId and resets `bootText`/`stage`.

**References**
- `frontend/src/core/components/easter-eggs/FakeCrashOverlay.vue:46-74` (simulateCrash/typewriter/watch)
- Vue watch cleanup reference: https://vuejs.org/guide/essentials/watchers.html#side-effect-cleanup

**Acceptance Criteria**
- Add a vitest unit test to toggle `show` rapidly and assert:
  - no stale `emit('complete')` after `show=false`
  - `bootText`/`stage` don’t progress from a stale run

---

### 6) Frontend: ChangelogModal window.open hardened (tabnabbing)

**What to do**
- In `handleViewAllChangelog`, call `window.open(url, '_blank', 'noopener,noreferrer')`.
- If the returned handle is non-null, set `newWindow.opener = null`.

**References**
- `frontend/src/modules/profile/components/ChangelogModal.vue:81-86`
- MDN/CWE references:
  - https://developer.mozilla.org/en-US/docs/Web/API/Window/open
  - https://cwe.mitre.org/data/definitions/1022.html

**Acceptance Criteria**
- Add/adjust a unit test that asserts `window.open` called with features containing `noopener,noreferrer`.

---

### 7) Frontend: AboutView version click accessibility

**What to do**
- Replace clickable `<span>` for `frontendVersion` with semantic `<button type="button">`.
- Preserve styling classes; ensure visible focus (add focus-visible ring if needed).

**References**
- `frontend/src/modules/profile/views/AboutView.vue:62-67`

**Acceptance Criteria**
- Unit test (or component test) verifies element is a button and is focusable.

---

### 8) Frontend: room destroy uses refund metadata; remove hardcoded percent

**What to do**
- Update `useRoomStore.destroyRoom` to return refund metadata from the backend instead of `Promise<void>`.
- Update `RoomDetailModal.vue` destroy handler to use returned metadata in toast.
- Remove hardcoded `(50%)`.

**References**
- `frontend/src/modules/rooms/stores/room.ts:67-85`
- `frontend/src/modules/rooms/components/RoomDetailModal.vue:258-262`

**Acceptance Criteria**
- `pnpm test` includes a unit test verifying toast text uses returned rate or caps (no hardcoded string).

---

### 9) Frontend: guard loadRadioStats against missing auth token

**What to do**
- In `loadRadioStats`, guard on `authStore.token` before creating Authorization header.
- Either return early when unauthenticated, or ensure header is only set with a guaranteed string.

**References**
- `frontend/src/modules/rooms/components/RoomDetailModal.vue:345-358` (header construction at `:350`)

**Acceptance Criteria**
- Unit test verifies request is skipped or header not constructed when token is falsy.

---

### 10) Tests: fix useFakeCrash + useGaryMode test isolation

**What to do**
- `useFakeCrash.test.ts`: call `resetCrash()` in `beforeEach` (alongside existing localStorage/timer setup) so `triggerFakeCrash` doesn’t short-circuit.
- `useGaryMode.test.ts`:
  - in `beforeEach`, set `isGaryMode.value = false`, call `resetGaryUnlocked()`, and `vi.clearAllTimers()`.
  - for localStorage assertion after `triggerGaryMode()`, `await nextTick()` before reading `localStorage`.

**References**
- `frontend/src/core/composables/useFakeCrash.ts:8-12, 37-43`
- `frontend/tests/unit/composables/useFakeCrash.test.ts:82-93` (failing area)
- `frontend/src/core/composables/useGaryMode.ts:7-10, 26-35`
- `frontend/tests/unit/composables/useGaryMode.test.ts:26-34, 54-63`

**Acceptance Criteria**
- `pnpm test` passes reliably when running:
  - full suite
  - each file individually

---

## Commit Strategy

Prefer 2–3 atomic commits (or a single commit if you prefer), e.g.:
1) `fix(backend): persist room build_price and return refund metadata`
2) `fix(frontend): consume destroy refund + harden crash/modal/about`
3) `test: stabilize composable tests`

---

## Defaults Applied (override if needed)
- **Refund rounding**: keep current behavior (`int(...)` truncation) unless you specify `floor`/`round` explicitly.
