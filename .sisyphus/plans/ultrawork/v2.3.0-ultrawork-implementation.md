# v2.3.0 Ultrawork Implementation Plan

**Created:** 2026-01-23
**Scope:** P0 Storage Fix + P1 Pregnancy Debug
**Estimated Time:** 14-16 hours

---

## Phase 1: P0 - Exploration Storage Validation (8h)

### P0-1: Add Storage Space Counting & Validation

**File:** `backend/app/crud/storage.py` (NEW)

```python
from sqlmodel import select
from sqlmodel.ext.asyncio.session import AsyncSession
from app.models.storage import Storage
from app.models.weapon import Weapon
from app.models.outfit import Outfit
from app.models.junk import Junk

async def count_storage_items(db_session: AsyncSession, storage_id: UUID4) -> int:
    """Count total items in storage."""
    weapons = await db_session.execute(select(Weapon).where(Weapon.storage_id == storage_id))
    outfits = await db_session.execute(select(Outfit).where(Outfit.storage_id == storage_id))
    junk = await db_session.execute(select(Junk).where(Junk.storage_id == storage_id))

    return (
        len(weapons.scalars().all()) +
        len(outfits.scalars().all()) +
        len(junk.scalars().all())
    )

async def get_available_space(db_session: AsyncSession, storage_id: UUID4) -> int:
    """Get available storage space."""
    storage = await db_session.get(Storage, storage_id)
    used = await count_storage_items(db_session, storage_id)
    return storage.max_space - used

async def update_used_space(db_session: AsyncSession, storage_id: UUID4) -> None:
    """Update used_space field based on actual item count."""
    storage = await db_session.get(Storage, storage_id)
    storage.used_space = await count_storage_items(db_session, storage_id)
    db_session.add(storage)
```

**Effort:** 1 hour

---

### P0-2: Add Storage Validation to Coordinator

**File:** `backend/app/services/exploration/coordinator.py`

**Modify `_transfer_loot_to_storage()` method (line 254):**

```python
import logging
from app.crud import storage as crud_storage

logger = logging.getLogger(__name__)

async def _transfer_loot_to_storage(self, db_session: AsyncSession, exploration: Exploration) -> dict:
    """
    Transfer loot items from exploration to vault storage.

    Returns dict with:
        - transferred: list of items successfully transferred
        - overflow: list of items that couldn't fit
    """
    if not exploration.loot_collected:
        return {"transferred": [], "overflow": []}

    vault = await crud_vault.get(db_session, exploration.vault_id)

    # Check available space
    available_space = await crud_storage.get_available_space(db_session, vault.storage.id)

    logger.info(
        "Storage transfer starting",
        extra={
            "vault_id": str(vault.id),
            "available_space": available_space,
            "items_to_transfer": len(exploration.loot_collected),
        }
    )

    # Sort loot by rarity (legendary > rare > uncommon > common)
    rarity_priority = {"legendary": 4, "rare": 3, "uncommon": 2, "common": 1}
    sorted_loot = sorted(
        exploration.loot_collected,
        key=lambda x: rarity_priority.get(x.get("rarity", "common").lower(), 0),
        reverse=True
    )

    transferred = []
    overflow = []
    items_added = 0

    # Load item data for lookups
    weapons_data = data_loader.load_weapons()
    outfits_data = data_loader.load_outfits()

    for loot_item in sorted_loot:
        # Check if space available
        if items_added >= available_space:
            overflow.append(loot_item)
            logger.warning(
                "Storage full - item dropped",
                extra={
                    "item_name": loot_item.get("item_name"),
                    "rarity": loot_item.get("rarity"),
                    "items_in_storage": items_added,
                }
            )
            continue

        item_type = loot_item.get("item_type", "junk")
        item_name = loot_item.get("item_name", "Unknown Item")
        rarity_str = loot_item.get("rarity", "Common")

        # Convert rarity string to enum
        try:
            rarity = RarityEnum[rarity_str.upper()]
        except (KeyError, AttributeError):
            rarity = RarityEnum.COMMON

        # Create item (same logic as before)
        if item_type == "weapon":
            weapon_data = next((w for w in weapons_data if w["name"] == item_name), None)
            if weapon_data:
                weapon = Weapon(
                    name=weapon_data["name"],
                    rarity=rarity,
                    value=weapon_data.get("value"),
                    weapon_type=WeaponTypeEnum[weapon_data["weapon_type"].upper()],
                    weapon_subtype=WeaponSubtypeEnum[weapon_data["weapon_subtype"].upper()],
                    stat=weapon_data["stat"],
                    damage_min=weapon_data["damage_min"],
                    damage_max=weapon_data["damage_max"],
                    storage_id=vault.storage.id,
                )
                db_session.add(weapon)
                items_added += 1
                transferred.append(loot_item)
                logger.info(
                    "Item transferred to storage",
                    extra={"item_type": "weapon", "item_name": item_name, "rarity": rarity_str}
                )

        elif item_type == "outfit":
            outfit_data = next((o for o in outfits_data if o["name"] == item_name), None)
            if outfit_data:
                outfit = Outfit(
                    name=outfit_data["name"],
                    rarity=rarity,
                    value=outfit_data.get("value"),
                    outfit_type=OutfitTypeEnum[outfit_data["outfit_type"].upper().replace(" ", "_")],
                    gender=GenderEnum[outfit_data["gender"].upper()] if outfit_data.get("gender") else None,
                    storage_id=vault.storage.id,
                )
                db_session.add(outfit)
                items_added += 1
                transferred.append(loot_item)
                logger.info(
                    "Item transferred to storage",
                    extra={"item_type": "outfit", "item_name": item_name, "rarity": rarity_str}
                )

        else:
            junk = Junk(
                name=item_name,
                junk_type=JunkTypeEnum.VALUABLES,
                rarity=rarity,
                description="Found during wasteland exploration",
                storage_id=vault.storage.id,
            )
            db_session.add(junk)
            items_added += 1
            transferred.append(loot_item)
            logger.info(
                "Item transferred to storage",
                extra={"item_type": "junk", "item_name": item_name, "rarity": rarity_str}
            )

    # Update used_space
    await crud_storage.update_used_space(db_session, vault.storage.id)

    if overflow:
        logger.warning(
            "Storage overflow occurred",
            extra={
                "vault_id": str(vault.id),
                "overflow_count": len(overflow),
                "transferred_count": len(transferred),
            }
        )

    return {"transferred": transferred, "overflow": overflow}
```

**Also update `_apply_rewards()` to handle overflow:**

```python
# Line ~241 - modify the transfer call
transfer_result = await self._transfer_loot_to_storage(db_session, exploration)

# Add overflow to rewards schema
return RewardsSchema(
    caps=total_caps,
    items=transfer_result["transferred"],
    overflow_items=transfer_result["overflow"],  # NEW FIELD
    experience=experience,
    distance=exploration.total_distance,
    enemies_defeated=exploration.enemies_encountered,
    events_encountered=len(exploration.events),
)
```

**Effort:** 3 hours

---

### P0-3: Add Storage Space API Endpoint

**File:** `backend/app/api/v1/endpoints/storage.py` (NEW)

```python
"""Storage management endpoints."""
import logging

from fastapi import APIRouter, Depends
from pydantic import UUID4
from sqlmodel.ext.asyncio.session import AsyncSession

from app.api.deps import CurrentUser, get_async_session
