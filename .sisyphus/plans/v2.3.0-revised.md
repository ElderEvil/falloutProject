# v2.3.0 Backend Stability & Testing - REVISED Plan

**Status:** Ready for Review  
**Created:** 2026-01-23  
**Branch:** `feat/v2.3.0`  
**Target Coverage:** 44.5% ‚Üí 70-75%  
**Estimated Effort:** 1.5-2 days

---

## REVISION: Middleware Tests Removed

**Removed from scope:**
- ‚ùå app/middleware/security.py tests (23 tests)
- ‚ùå app/middleware/request_id.py tests (0% coverage remains)

**Reasoning:** Can be addressed in separate security-focused sprint

---

## Revised Core Tasks

### 1. Datetime Deprecation Fix (HIGH PRIORITY) ‚è∞
- **Scope:** 68 instances across 21 files
- **Effort:** 30-60 minutes
- **Impact:** Removes Python 3.13+ warnings
- **Quick Win:** ‚úÖ Mechanical replacement, low risk

### 2. Database Layer Testing (HIGH PRIORITY) üíæ
- **Coverage:** 0% ‚Üí 75%
- **Tests:** 16 new tests
- **Effort:** 2-3 hours
- **Quick Win:** ‚úÖ Straightforward, existing patterns

### 3. Unique Room Verification (MEDIUM PRIORITY) üè†
- **Tests:** 8 new tests
- **Effort:** 1-2 hours
- **Quick Win:** ‚úÖ Simple API tests, existing logic

### 4. Incident Service Testing (MEDIUM PRIORITY) ‚öîÔ∏è
- **Coverage:** 28% ‚Üí 70%
- **Tests:** 20-25 new tests
- **Effort:** 6-8 hours
- **Complexity:** HIGH (session isolation fix required)

### 5. Game Loop Testing (LOWER PRIORITY) ‚öôÔ∏è
- **Coverage:** 54% ‚Üí 70%
- **Tests:** 20-25 new tests
- **Effort:** 6-8 hours
- **Complexity:** HIGH (multi-phase orchestration)

---

## Revised Test Count Summary

| Module | Current Tests | New Tests | Total | Coverage Target |
|--------|--------------|-----------|-------|-----------------|
| ~~middleware/~~ | ~~0~~ | ~~23~~ | ~~23~~ | ~~Deferred~~ |
| db/ | 0 | 16 | 16 | 75% |
| room (unique) | ~15 | 8 | 23 | 95% |
| incident_service | ~10 (skipped) | 20-25 | 30-35 | 70% |
| game_loop | ~10 (indirect) | 20-25 | 30-35 | 70% |
| **TOTAL** | **570** | **64-74** | **634-644** | **70-75%** |

**Revised Coverage Trajectory:** 44.5% ‚Üí 70-75%

---

## Quick Wins Assessment

### Tier 1: Fastest Wins (Half Day)
1. **Datetime Fix** - 30-60 min, mechanical, zero risk
2. **DB Init Tests** - 2-3 hours, straightforward seeding
3. **Unique Room Tests** - 1-2 hours, simple API validation

**Impact:** ~24 tests added, ~15-20% coverage gain

### Tier 2: Medium Effort (1 Day)
4. **DB Session Tests** - 2-3 hours, requires async understanding
5. **Incident Service (Basic)** - 4-6 hours, spawn + basic combat

**Impact:** ~30 additional tests, ~20-25% coverage gain

### Tier 3: Complex (Optional)
6. **Game Loop Testing** - 6-8 hours, complex orchestration
7. **Incident Service (Advanced)** - 4-6 hours, spread mechanics, loot

---

## QUESTION: Do You Want Quick Wins First?

Before I finalize this plan, **what's your priority?**

**Option A: Quick Wins Only (Recommended Start)**
- Focus on Tier 1: Datetime + DB Init + Unique Rooms
- Get to ~60-65% coverage in half day
- Low risk, high visibility
- **Deliverable:** Clean foundation, all easy wins completed

**Option B: Balanced Approach**
- Tier 1 + Tier 2 (DB + some incident tests)
- Get to ~70% coverage in 1.5 days
- Moderate complexity
- **Deliverable:** Solid coverage, some complex tests

**Option C: Full Sprint**
- All tiers including game loop
- Get to ~75% coverage in 2+ days
- High complexity
- **Deliverable:** Maximum coverage, all planned work

**Option D: Custom Priority**
- You tell me what's most important
- I'll reorganize the plan accordingly

---

## My Recommendation

Start with **Option A (Quick Wins)** to:
1. Build momentum with easy successes
2. Verify test infrastructure works smoothly
3. Identify any blockers early
4. Deliver visible progress quickly

Then reassess whether to continue with Tier 2/3 based on:
- Time remaining
- Complexity encountered
- Coverage achieved
- Other priorities

**What do you prefer?**
