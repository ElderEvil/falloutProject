name: Deploy to Staging (TrueNAS)

on:
  workflow_dispatch:
    inputs:
      backend_image_tag:
        description: 'Backend image tag (e.g., latest, sha-abc123)'
        required: false
        default: 'latest'
      frontend_image_tag:
        description: 'Frontend image tag (e.g., latest, sha-abc123)'
        required: false
        default: 'latest'
      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend services'
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy frontend'
        required: false
        type: boolean
        default: true
      restart_all:
        description: 'Restart all services (hard restart)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to TrueNAS Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TRUENAS_SSH_KEY }}" > ~/.ssh/truenas_key
          chmod 600 ~/.ssh/truenas_key
          ssh-keyscan -H ${{ secrets.TRUENAS_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} "echo 'âœ… SSH connection successful'"

      - name: Pull latest images
        run: |
          echo "ðŸ”„ Pulling Docker images on TrueNAS..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Login to Docker Hub if credentials provided
            if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
              echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            fi

            # Pull specified images
            if [[ "${{ inputs.deploy_backend }}" == "true" ]]; then
              echo "Pulling backend image: ${{ secrets.DOCKER_USERNAME }}/fastapi:${{ inputs.backend_image_tag }}"
              docker pull ${{ secrets.DOCKER_USERNAME }}/fastapi:${{ inputs.backend_image_tag }}
            fi

            if [[ "${{ inputs.deploy_frontend }}" == "true" ]]; then
              echo "Pulling frontend image: ${{ secrets.DOCKER_USERNAME }}/vuejs:${{ inputs.frontend_image_tag }}"
              docker pull ${{ secrets.DOCKER_USERNAME }}/vuejs:${{ inputs.frontend_image_tag }}
            fi
          EOF

      - name: Update docker-compose to use specific tags
        if: ${{ inputs.backend_image_tag != 'latest' || inputs.frontend_image_tag != 'latest' }}
        run: |
          echo "ðŸ“ Updating docker-compose.yml with specific image tags..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Backup original
            cp docker-compose.yml docker-compose.yml.bak

            # Update image tags in docker-compose
            if [[ "${{ inputs.deploy_backend }}" == "true" ]]; then
              sed -i "s|build:|image: ${{ secrets.DOCKER_USERNAME }}/fastapi:${{ inputs.backend_image_tag }}\n    #build:|g" docker-compose.yml
            fi

            if [[ "${{ inputs.deploy_frontend }}" == "true" ]]; then
              sed -i "s|build:|image: ${{ secrets.DOCKER_USERNAME }}/vuejs:${{ inputs.frontend_image_tag }}\n    #build:|g" docker-compose.yml
            fi
          EOF

      - name: Run database migrations
        if: ${{ inputs.run_migrations && inputs.deploy_backend }}
        run: |
          echo "ðŸ”„ Running Alembic migrations..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Run migrations in a temporary container
            docker-compose run --rm fastapi alembic upgrade head

            if [ $? -eq 0 ]; then
              echo "âœ… Migrations completed successfully"
            else
              echo "âŒ Migration failed!"
              exit 1
            fi
          EOF

      - name: Deploy services (restart all)
        if: ${{ inputs.restart_all }}
        run: |
          echo "ðŸ”„ Restarting all services..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Stop and remove all containers
            docker-compose down

            # Start all services
            docker-compose up -d

            echo "âœ… All services restarted"
          EOF

      - name: Deploy specific services (rolling restart)
        if: ${{ !inputs.restart_all }}
        run: |
          echo "ðŸš€ Deploying services..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            SERVICES=""

            if [[ "${{ inputs.deploy_backend }}" == "true" ]]; then
              SERVICES="$SERVICES fastapi celery_worker celery_beat"
            fi

            if [[ "${{ inputs.deploy_frontend }}" == "true" ]]; then
              SERVICES="$SERVICES vuejs"
            fi

            if [ -n "$SERVICES" ]; then
              echo "Restarting services: $SERVICES"
              docker-compose up -d --force-recreate --no-deps $SERVICES
              echo "âœ… Services deployed"
            else
              echo "âš ï¸ No services selected for deployment"
            fi
          EOF

      - name: Wait for services to be healthy
        run: |
          echo "â³ Waiting for services to be healthy..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Wait up to 60 seconds for services to be healthy
            timeout=60
            elapsed=0

            while [ $elapsed -lt $timeout ]; do
              if docker-compose ps | grep -q "Up (healthy)"; then
                echo "âœ… Services are healthy"
                break
              fi
              echo "Waiting for services... ($elapsed/$timeout)"
              sleep 5
              elapsed=$((elapsed + 5))
            done

            if [ $elapsed -ge $timeout ]; then
              echo "âš ï¸ Timeout waiting for services to be healthy"
              docker-compose ps
            fi
          EOF

      - name: Verify deployment
        run: |
          echo "ðŸ“Š Deployment status:"

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            echo "=== Running containers ==="
            docker-compose ps

            echo ""
            echo "=== Container logs (last 20 lines) ==="
            if [[ "${{ inputs.deploy_backend }}" == "true" ]]; then
              echo "--- FastAPI ---"
              docker-compose logs --tail=20 fastapi
            fi

            if [[ "${{ inputs.deploy_frontend }}" == "true" ]]; then
              echo "--- Vue.js ---"
              docker-compose logs --tail=20 vuejs
            fi
          EOF

      - name: Health check
        run: |
          echo "ðŸ¥ Running health checks..."

          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            if [[ "${{ inputs.deploy_backend }}" == "true" ]]; then
              echo "Checking backend health..."
              docker-compose exec -T fastapi curl -f http://localhost:8000/healthcheck || echo "âš ï¸ Backend health check failed"
            fi

            echo "âœ… Health checks complete"
          EOF

      - name: Cleanup
        run: |
          ssh -i ~/.ssh/truenas_key ${{ secrets.TRUENAS_USER }}@${{ secrets.TRUENAS_HOST }} << 'EOF'
            cd ${{ secrets.TRUENAS_PROJECT_PATH }}

            # Restore original docker-compose if backup exists
            if [ -f docker-compose.yml.bak ]; then
              mv docker-compose.yml.bak docker-compose.yml
            fi

            # Clean up old images
            docker image prune -f
          EOF

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** TrueNAS Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** ${{ secrets.DOCKER_USERNAME }}/fastapi:${{ inputs.backend_image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend:** ${{ secrets.DOCKER_USERNAME }}/vuejs:${{ inputs.frontend_image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Migrations:** ${{ inputs.run_migrations }}" >> $GITHUB_STEP_SUMMARY
          echo "**Restart All:** ${{ inputs.restart_all }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
