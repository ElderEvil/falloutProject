# Draft: v2.8.5 refund + UI/security/test fixes

## Requirements (confirmed)
- Backend: Add explicit type annotation for `DESTROY_ROOM_REFUND_RATE` in `backend/app/crud/room.py` (declare as float).
- Backend: Fix room destroy refund logic so refund reflects **50% of actual price paid**, not a flat `base_cost + incremental_cost`.
- Frontend: Prevent overlapping async runs in `FakeCrashOverlay.vue` when `props.show` toggles quickly (use run token/cancellation).
- Frontend: Prevent tabnabbing in `ChangelogModal.vue` when opening external changelog (`noopener,noreferrer` + `newWindow.opener = null`).
- Frontend: Make version click in `AboutView.vue` keyboard accessible (prefer semantic `<button>`).
- Frontend: Remove hardcoded "(50%)" string in `RoomDetailModal.vue` toast; use dynamic value (or omit percent).
- Frontend: Guard `loadRadioStats` against missing `authStore.token` (avoid invalid Authorization header).
- Tests: Fix module-level singleton leaks:
  - `useFakeCrash.test.ts`: ensure `resetCrash()` runs before relevant tests.
  - `useGaryMode.test.ts`: reset module-level refs/timers between tests and await flush before asserting localStorage.

## Research Findings (code locations)

### Backend refund logic
- Constant:
  - `backend/app/crud/room.py:18` → `DESTROY_ROOM_REFUND_RATE = 0.5` (needs `: float`)
- Build-time price (charged):
  - `backend/app/crud/room.py:65-80` → `get_room_build_price()` returns `base_cost + (len(rooms_in_category) * incremental_cost)`
  - `backend/app/crud/room.py:183-185` (inside `build()`) → withdraw caps by this computed price
- Destroy-time refund (credited):
  - `backend/app/crud/room.py:261-272` → refund uses `base_cost + incremental_cost (+ upgrades)` then *0.5
  - **Mismatch**: destroy ignores the ordinal multiplier used at build time.
- Room model does **not** store any paid/build price:
  - `backend/app/models/room.py:19-22` cost fields exist; no `build_price`/`paid_cost` field.
- Destroy is a **hard delete** (history loss):
  - `backend/app/crud/base.py:211-240` hard delete path used → destroyed rooms disappear.

### Important argument (input is incomplete)
- The suggested alternate approach "compute ordinal at destroy time" cannot reliably reconstruct *actual paid price* once any prior rooms were destroyed, because hard deletes erase historical rows.
- Therefore, if the requirement is truly "refund 50% of actual paid price", then:
  - We need to **persist a paid-price ledger** (e.g., `Room.build_price`) going forward, OR
  - Switch to **soft delete/ledger** to preserve history.
  - Otherwise we can only provide an approximation for legacy rooms.

### Frontend issues
- FakeCrashOverlay overlap:
  - `frontend/src/core/components/easter-eggs/FakeCrashOverlay.vue`
  - `simulateCrash()` started from watch without awaiting; no cancellation; can emit stale `complete`.
  - Guard points: before each await and before `emit('complete')`.
- Tabnabbing:
  - `frontend/src/modules/profile/components/ChangelogModal.vue:81-86` uses `window.open(url, '_blank')` without features.
  - Recommended: `window.open(url, '_blank', 'noopener,noreferrer')` and set `newWindow.opener = null`.
- AboutView accessibility:
  - `frontend/src/modules/profile/views/AboutView.vue:62-67` clickable `<span @click>` should be a `<button type="button">`.
- RoomDetailModal:
  - `frontend/src/modules/rooms/components/RoomDetailModal.vue:260` toast hardcodes `(50%)`.
  - `loadRadioStats` uses `Authorization: Bearer ${authStore.token}` even if token is null.

### Tests
- `useFakeCrash` module-level refs leak between tests:
  - `frontend/src/core/composables/useFakeCrash.ts` module-scope refs (`isCrashing`, etc.).
  - Fix tests by calling `resetCrash()` in `beforeEach` (in addition to `resetCrashUnlocked()` where needed).
- `useGaryMode` module-level singletons leak:
  - `frontend/src/core/composables/useGaryMode.ts` has module-scope `isGaryMode`, `garyUnlocked`, `garyTimer`.
  - Reset strategy: either set exposed refs + `vi.clearAllTimers()`, or use `vi.resetModules()` + dynamic import.
  - For localStorage assertion, add `await nextTick()` after `triggerGaryMode()`.

## External References
- MDN `Window.open()` features `noopener` / `noreferrer`: https://developer.mozilla.org/en-US/docs/Web/API/Window/open
- MDN `rel=noopener`: https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Attributes/rel/noopener
- CWE-1022 suggests setting `opener` to null: https://cwe.mitre.org/data/definitions/1022.html
- Vue watch cleanup / invalidation pattern: https://vuejs.org/guide/essentials/watchers.html#side-effect-cleanup
- Vue `watch` API cleanup hook: https://vuejs.org/api/reactivity-core.html#watch

## Open Questions
1. (Resolved) Refund policy: **Refund actual paid** (persist paid build price on Room at build time; refund 50% of paid build price + paid upgrades).
2. (Resolved) Destroy API shape: **Backend returns refund data** (prefer JSON including `refund_caps` and `refund_rate`).
3. (Resolved) Legacy rooms: **Best-effort backfill** (estimate paid build price by created_at ordering; acknowledge hard-delete history means approximation).
4. (Resolved) Test isolation: **Reset via public API** (call reset functions / set refs and clear timers in `beforeEach`).

## Decisions (confirmed)
- Backend will implement a persisted paid-price field on `Room` (name TBD: `build_price` or `paid_build_price`).
- Backend destroy endpoint will return refund metadata (not 204) so UI can display real values.
- Backfill will compute best-effort ordinal at time of build using `created_at` ordering among existing rooms.
- Frontend toast will use the returned `refund_rate`/`refund_caps` instead of hardcoded "50%".

## Scope Boundaries
- INCLUDE: only the items listed above.
- EXCLUDE (unless you opt in): changing incremental pricing semantics (currently computed by category, not name), soft-delete/ledger refactor beyond what is required for refund accuracy.
